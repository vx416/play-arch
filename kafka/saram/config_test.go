package saram

import (
	"fmt"
	"runtime"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
)

var bigStr = `BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|BG02|1545495097711|0|100000000,115000000,2;10000000,3000000000,1;3400000,3000000000,1;3300000,1500000000,1;3000000,5000000000,1;2560000,1900000000,1;2000000,2004999999,1;660000,500000000,1;600000,12500000000,2;500000,8700000000,1;5000,500000000000,1;5,10000000000000,1;1,1000000000000,1|290000000,10000000,1;1000000000,100000000,1;2000000000,100000000,1;3000000000,100000000,1;4000000000,100000000,1;5000000000,100000000,1;6000000000,100000000,1;7000000000,100000000,1;8000000000,100000000,1;9000000000,100000000,1;10000000000,100000000,1
BG02|1561017385239|0|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|1|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|2|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|3|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|4|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|5|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|6|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|7|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|8|100000000,300000000,1|10000000000,300000000,1;11100000000,300000000,1;11200000000,300000000,1|9|1,300000000,1|10000000000,300000000,1;11000000000,600000000,2|10|1,300000000,1|10000000000,900000000,3|11|1,300000000,1|1,900000000,3|12|100000000,300000000,1|10000000000,900000000,3
BG02|1535343261000|0|5100000000,20750000,2;5000000000,20750000,2|`

func TestMemoryUsage(t *testing.T) {
	topics := GetTopics("topic", 30)
	// go PubMessages(topics, bigStr, 100)
	pcs, err := PartitionConsumer(topics)
	assert.NoError(t, err)
	msg := <-pcs[0].Messages()
	t.Log(msg)
	time.Sleep(5 * time.Second)
	PrintMemUsage()
	time.Sleep(1 * time.Second)
}

func PrintMemUsage() {
	var m runtime.MemStats
	runtime.ReadMemStats(&m)
	// For info on each, see: https://golang.org/pkg/runtime/#MemStats
	fmt.Printf("Alloc = %v MiB", bToMb(m.Alloc))
	fmt.Printf("\tTotalAlloc = %v MiB", bToMb(m.TotalAlloc))
	fmt.Printf("\tSys = %v MiB", bToMb(m.Sys))
	fmt.Printf("\tNumGC = %v\n", m.NumGC)
}

func bToMb(b uint64) uint64 {
	return b / 1024 / 1024
}

// 33
// 22
